最近看`C++17完全指南`的`第二十九章 多态内存资源 (PMR)` https://github.com/MeouSker77/Cpp17/blob/master/markdown/src/ch29.md 里面`内存分配器`,`内存资源`等概念, 通过使用`std::pmr`里的`内存资源`可使用`stl`提供的`字符串,容器`等, 减少向系统申请内存分配次数.

顺便的对如何对`自定义类型`进行内存预分配产生兴趣, 然后就触及到`内存池`这个概念.

通过查找, 找到了`cacay/MemoryPool`这个库, https://github.com/cacay/MemoryPool, 代码量`300行`左右, 读起来不费力, 使用时, 必须`指定类型`, 且构造的这个内存池, 只能用于`指定类型`. 可以根据需要, 对多个类型, 分别进行`内存池`缓存.

## 该内存池原理

先分配`指定类型`的一块较大的`内存块`, 只在分配这个块时,做一次内存分配操作, 后续实际对`指定类型`进行使用时, 不做内存分配和释放的调用, 直接在`内存块`通过`指针记录`进行`读取`和`放回`.

## 该内存池涉及到的`new`相关的几个概念点:

- `new` : new 操作符,是个关键字,不能改变`new`的行为. 功能: 1,分配对象内存; 2,调对象构造函数.
- `operator new` : 被`new`操作符`隐含调用`,用来分配内存的函数,可以重写或重载这个函数来改变它的行为.
- `placement new` : 特殊的`operator new`,该函数不分配内存, 通过已有的内存指针,以`new (ptr)`形式使用, `ptr`为已有内存指针. 在`内存池`里面有使用场景.

## 该内存池内部操作

- 先通过调用系统的`operator new(BlockSize=4KB)`在系统内存分配一个较大(4KB)内存块`curBlock`, 在`curBlock`头部放指向前一个`curBlock`的指针,更新`curPointer`指向第一个可用的内存记录, 在`curBlock`上只对`指定类型`进行内存`读取`和`放回`, `读取`和`放回`, 是在`curBlock`上通过`curPointer`直接操作, 不涉及内存`分配`和`释放`的系统调用.
- 读取: 在`curBlock`上通过`curPointer`,获得`指定类型`一个对象所需内存, 然后通过``.
- 放回: 对象释放后, 通过`单链表`记录已释放内存
- 构造对象时:
  - `单链表`上有可用内存, 用`单链表`记录的,并减少`单链表`可用内存记录,
  - `单链表`没有可用内存, 检查当前内存块`curBlock`上的`curPointer`
    - 没到`curBlock`末尾, 继续从`curBlock`上读取,并更新`curPointer`
    - 到了`curBlock`末尾, 新分配一个`curBlock`
